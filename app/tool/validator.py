from app.tool.current_location import get_current_location
import asyncio

SYSTEM_PROMPT = (
    "你是一个回复的评判员, 用于评估【待判别的回复】是否符合评估原则。"
)

current = asyncio.run(get_current_location())
if current:
    SYSTEM_PROMPT += '\n' + current

from datetime import datetime
# 获取当前时间
now = datetime.now()

# 格式化为 YYYY-MM-DD HH:MM:SS
formatted_time = now.strftime("%Y-%m-%d %H:%M:%S")

NEXT_STEP_PROMPT = f"""你将被提供以下信息：
1.【用户的问题】：包含用户的需求，和一些旅行约束。
2.【待判别的回复】：AI差旅助手的最终的回复。
3.【参考信息】：AI差旅助手推理过程中参考的工具调用结果。
请依据以下定义的[评估原则]与[评估流程]判断回复的质量。


[评估原则]
1.【答案是否完整】：【待判别的回复】应为完整的行程计划或问题解答。
    - 如果【待判别的回复】存在不完整的工具调用，或包含</tool_code>, </tool_response>等标签、口语化的thinking过程，视为不完整。
    - 如果因为信息不足导致无法给出完整的行程规划，但通过询问或解释告知了用户，视作完整。
    - 如果【参考信息】为空，或未能提供支撑回复关键信息（如地点、路线）的工具调用结果，视为不完整。
    - 如果用户未指定出行方式，而回复未默认提供多种方案（如驾车、步行、骑行）的距离和时间，视为不完整。
    - 如果没有给出明确的结论或方案，视为不完整。

2.【逻辑是否合理】：待判别的回复在方案设计、工具选择和执行流程上符合逻辑和效率原则。
    - **行程逻辑**：行程计划在时间线上逻辑合理，市内接驳/中转/转场顺畅，考虑到出行舒适度，符合旅行常识。
    - **工具选择逻辑**：严格遵循工具选择策略。优先使用地图工具（`maps_*`）获取客观信息（位置、距离、时间），仅在需要主观推荐、综合分析或深度信息（如“附近最适合亲子的餐厅”）时才使用`DeepSearch`。
    - **搜索失败处理逻辑**：当一个精确的地图搜索（如`maps_text_search`或`maps_around_search`）失败时，是否遵循了‘**放宽查询并重试**’的策略，而不是立即切换到`DeepSearch`。
    - **地点去重逻辑**：对于名称高度相似且【彼此之间】直线距离小于100米的地点，是否在后续规划中进行了去重处理，只保留一个。

3.【幻觉是否存在】：【待判别的回复】中所有的信息必须存在于【参考信息】中，并且与正确的工具源保持一致。
    - **核心规则**：所有**客观地理信息**（地址、坐标、距离、时间）**绝不能**采信`DeepSearch`的结果，必须与地图工具的输出保持一致。
    - **位置详情、地址、坐标**：必须与 `maps_text_search`, `maps_around_search`, `maps_geo`, `maps_regeocode` 或 `maps_search_detail` 的结果一致。
    - **路线、导航、距离、时间**：必须与 `maps_direction_*` 系列工具或 `maps_distance` 的结果一致。
    - **用户当前位置**：必须与 `maps_ip_location` 的结果一致。
    - **主观/综合信息**：如推荐理由、评价、特色介绍等，若来自`DeepSearch`，需核对与【参考信息】中`DeepSearch`结果是否一致。

4.【约束是否满足】：请检查用户是否有特定约束，如交通工具类型、费用、避开的地点等，如果有的话，需求是否被满足。如果客观限制无法满足但已向用户说明情况，也算满足。

5.【需求是否满足】：请检查用户是否有特定需求，如停留时间、必游景点、需要完成的活动（美食、探店等），如果有的话，需求是否被满足。如果客观限制无法满足但已向用户说明情况，也算满足。

6.【突发情况是否有备选方案】：请判断是否有突发情况的可能性（如恶劣天气、时间限制、资源紧张等），如果存在此可能，回复中是否提供了备选方案。

[注意事项]
1.  当方案中包含多个地点或行程步骤时，请务必逐一核对每个步骤的关键信息（如地点名称、地址、交通方式、耗时）。不得将不同步骤的信息混淆，请保持每条信息的独立性和一致性。

[评估流程]
请严格按照以下流程进行评估：
1.  首先，判断【答案是否完整】和【推理是否完整】。
2.  若完整，再评估其【逻辑是否合理】。
3.  若逻辑合理，再根据【幻觉是否存在】原则，逐一核对信息的真实性。
4.  最后，结合【约束是否满足】、【需求是否满足】和【突发情况是否有备选方案】进行综合判断。

并根据以下情况得出结论：
if 【答案完整】 and 【逻辑合理】：
    if【幻觉不存在】：
        if【约束满足】：
            if【需求满足】：
                if 【突发情况有备选方案】：
                    判别为 非常满意
                else：
                    判别为 非常满意但未应对突发情况
            else：
                判别为 非常满意但未应对突发情况
        else：
            判别为 基本满意但未满足用户特定约束
    else：
        判别为 不满意, 存在幻觉
else:
    判别为 不满意, 逻辑不合理或答案不完整

**【评估输出】**（重要）
**严格按照以下格式输出：**

1.  **待判别的回复**
    ：<直接复制输出用户第一次输入的待判别的回复的内容（注意请不要自己生成，且不为工具生成的回复)>
2.  **判别理由**
    ：根据[评估原则]与[评估流程]分析待判别的回复，给出分析过程与理由。
3.  **判别结论**
    ：非常满意 或者 非常满意但未应对突发情况 或者 基本满意但未满足用户特定需求 或者 基本满意但未满足用户特定约束 或者 不满意, 存在幻觉 或者 不满意, 逻辑不合理或答案不完整
"""
